#!/usr/bin/env sh
# Commit message validation hook
# Enforces conventional commits format

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Allow skip with SKIP_HOOKS=1
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Skipping commit message validation${NC}"
    exit 0
fi

echo "${BLUE}üìù Validating commit message...${NC}"

# Ignore merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|remote)"; then
    echo "${GREEN}‚úÖ Merge commit - skipping validation${NC}"
    exit 0
fi

# Ignore revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    echo "${GREEN}‚úÖ Revert commit - skipping validation${NC}"
    exit 0
fi

# Conventional commit types
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Validate format: type(scope): description
if ! echo "$COMMIT_MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .{3,}"; then
    echo "${RED}‚ùå Invalid commit message format${NC}"
    echo ""
    echo "${YELLOW}Expected format:${NC}"
    echo "  <type>(<scope>): <description>"
    echo ""
    echo "${YELLOW}Valid types:${NC}"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style changes (formatting, etc.)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvements"
    echo "  test     - Test changes"
    echo "  build    - Build system changes"
    echo "  ci       - CI/CD changes"
    echo "  chore    - Maintenance tasks"
    echo ""
    echo "${YELLOW}Examples:${NC}"
    echo "  feat(auth): add JWT authentication"
    echo "  fix(api): resolve rate limiting bypass"
    echo "  docs(readme): update installation instructions"
    echo ""
    echo "${YELLOW}Your message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo "${YELLOW}To skip validation: SKIP_HOOKS=1 git commit${NC}"
    exit 1
fi

# Check message length
MSG_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c)
if [ "$MSG_LENGTH" -gt 100 ]; then
    echo "${YELLOW}‚ö†Ô∏è  Commit message is quite long (${MSG_LENGTH} chars)${NC}"
    echo "${YELLOW}   Consider keeping the first line under 100 characters${NC}"
fi

# Check for issue reference (optional but recommended)
if ! echo "$COMMIT_MSG" | grep -qE "#[0-9]+"; then
    echo "${YELLOW}üí° Tip: Reference an issue number with #123 in your commit message${NC}"
fi

echo "${GREEN}‚úÖ Commit message format is valid${NC}"
exit 0
