#!/usr/bin/env sh
# Post-checkout hook - Ensures dependencies are synced after branch switch

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_CHECKOUT=$3

# Only run on branch checkout (not file checkout)
if [ "$BRANCH_CHECKOUT" != "1" ]; then
    exit 0
fi

echo "${BLUE}üîÑ Post-checkout: Syncing environment...${NC}"
echo ""

# 1. CHECK IF DEPENDENCIES CHANGED
echo "${BLUE}üì¶ Checking if dependencies changed...${NC}"

if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" | grep -qE 'package\.json|pnpm-lock\.yaml'; then
    echo "${YELLOW}‚ö†Ô∏è  Dependencies have changed${NC}"
    echo "${BLUE}Running 'pnpm install'...${NC}"

    if pnpm install; then
        echo "${GREEN}‚úÖ Dependencies synchronized${NC}"
    else
        echo "${RED}‚ùå Failed to install dependencies${NC}"
        echo "${YELLOW}   Please run 'pnpm install' manually${NC}"
    fi
else
    echo "${GREEN}‚úÖ No dependency changes detected${NC}"
fi

# 2. CHECK IF .ENV.EXAMPLE CHANGED
echo ""
echo "${BLUE}üîê Checking environment configuration...${NC}"

if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" | grep -q '\.env\.example'; then
    echo "${YELLOW}‚ö†Ô∏è  .env.example has changed${NC}"
    echo "${YELLOW}   Please review and update your .env file accordingly${NC}"
fi

# 3. CLEAN BUILD ARTIFACTS (OPTIONAL)
echo ""
echo "${BLUE}üßπ Checking for stale build artifacts...${NC}"

if [ -d "dist" ] || [ -d "build" ] || [ -d ".next" ]; then
    echo "${YELLOW}üí° Tip: You may want to clean and rebuild:${NC}"
    echo "${YELLOW}   pnpm clean && pnpm build${NC}"
fi

echo ""
echo "${GREEN}‚úÖ Post-checkout complete${NC}"
