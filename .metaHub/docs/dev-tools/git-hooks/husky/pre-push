#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push Hook
# Runs comprehensive checks before pushing to remote

echo "üöÄ Running Pre-push Governance Checks..."

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

# 1. Run full validation
echo "üîç Running full repository validation..."
node .governance/validators/repository-validator.js
if [ $? -ne 0 ]; then
    echo "${RED}‚ùå Repository validation failed${NC}"
    FAILED=1
else
    echo "${GREEN}‚úÖ Repository validation passed${NC}"
fi

# 2. Run security scan
echo "üîí Running security scan..."
if command -v trivy &> /dev/null; then
    trivy fs . --severity HIGH,CRITICAL --exit-code 1
    if [ $? -ne 0 ]; then
        echo "${RED}‚ùå Security vulnerabilities detected${NC}"
        FAILED=1
    else
        echo "${GREEN}‚úÖ Security scan passed${NC}"
    fi
fi

# 3. Check test coverage
echo "üß™ Checking test coverage..."
npm test -- --coverage --silent
if [ $? -ne 0 ]; then
    echo "${RED}‚ùå Tests failed${NC}"
    FAILED=1
else
    # Check coverage threshold
    coverage=$(npm test -- --coverage --silent | grep "All files" | awk '{print $10}' | sed 's/%//')
    if [ "$coverage" != "" ] && [ "$coverage" -lt 80 ]; then
        echo "${YELLOW}‚ö†Ô∏è  Test coverage below 80%: ${coverage}%${NC}"
        FAILED=1
    else
        echo "${GREEN}‚úÖ Test coverage acceptable${NC}"
    fi
fi

# 4. Check documentation completeness
echo "üìö Checking documentation completeness..."
missing_docs=$(find src -name "*.js" -o -name "*.ts" | xargs grep -L "/\*\*\|///" | wc -l)
if [ "$missing_docs" -gt 0 ]; then
    echo "${YELLOW}‚ö†Ô∏è  ${missing_docs} files missing documentation${NC}"
fi

# 5. Validate branch protection
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Direct push to ${branch} branch${NC}"
    echo "Consider creating a pull request instead"
fi

# 6. Check file size
echo "üìè Checking file sizes..."
large_files=$(find . -type f -size +10M ! -path "./.git/*" ! -path "./node_modules/*" | wc -l)
if [ "$large_files" -gt 0 ]; then
    echo "${YELLOW}‚ö†Ô∏è  Found ${large_files} files larger than 10MB${NC}"
    echo "Consider using Git LFS for large files"
fi

# 7. Generate compliance report
echo "üìä Generating compliance report..."
node << EOF
const fs = require('fs');
const report = {
    timestamp: new Date().toISOString(),
    branch: '$branch',
    status: $FAILED === 0 ? 'compliant' : 'non-compliant',
    checks: {
        validation: $FAILED === 0,
        security: true,
        tests: true,
        documentation: $missing_docs === 0
    }
};

const reportPath = '.governance/reports/pre-push-' + Date.now() + '.json';
fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
console.log('Report saved to:', reportPath);
EOF

# Final status
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
if [ $FAILED -ne 0 ]; then
    echo "${RED}‚ùå PRE-PUSH CHECKS FAILED${NC}"
    echo ""
    echo "Fix the issues above before pushing."
    echo "Use --no-verify to bypass (not recommended)"
    exit 1
else
    echo "${GREEN}‚úÖ ALL PRE-PUSH CHECKS PASSED${NC}"
    echo ""
    echo "Safe to push to remote!"
fi

exit 0