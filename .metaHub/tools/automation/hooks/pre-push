#!/usr/bin/env sh
# Pre-push hook - Runs full test suite before pushing

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "${BLUE}üöÄ Running pre-push validation...${NC}"
echo ""

# Allow skip with SKIP_HOOKS=1
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Skipping hooks (SKIP_HOOKS=1)${NC}"
    exit 0
fi

# 1. RUN FULL TEST SUITE
echo "${BLUE}üß™ [1/4] Running full test suite...${NC}"
echo "${YELLOW}This may take a few minutes...${NC}"

if pnpm test; then
    echo "${GREEN}‚úÖ All tests passed${NC}"
else
    echo "${RED}‚ùå BLOCKED: Tests failed${NC}"
    echo "${YELLOW}   Fix failing tests before pushing${NC}"
    echo "${YELLOW}   Or use 'SKIP_HOOKS=1 git push' to skip (not recommended)${NC}"
    exit 1
fi

# 2. RUN BUILD
echo ""
echo "${BLUE}üî® [2/4] Running build...${NC}"

if pnpm build; then
    echo "${GREEN}‚úÖ Build successful${NC}"
else
    echo "${RED}‚ùå BLOCKED: Build failed${NC}"
    echo "${YELLOW}   Fix build errors before pushing${NC}"
    exit 1
fi

# 3. SECURITY SCAN
echo ""
echo "${BLUE}üîí [3/4] Running security scan...${NC}"

if [ -f ".automation/scripts/security-scan.sh" ]; then
    if bash .automation/scripts/security-scan.sh; then
        echo "${GREEN}‚úÖ Security scan passed${NC}"
    else
        echo "${RED}‚ùå BLOCKED: Security issues detected${NC}"
        echo "${YELLOW}   Fix security issues before pushing${NC}"
        exit 1
    fi
else
    echo "${YELLOW}‚ö†Ô∏è  Security scan script not found - skipping${NC}"
fi

# 4. CHECK FOR MERGE CONFLICTS
echo ""
echo "${BLUE}üîÄ [4/4] Checking for unresolved merge conflicts...${NC}"

if git diff --check; then
    echo "${GREEN}‚úÖ No merge conflicts${NC}"
else
    echo "${RED}‚ùå BLOCKED: Merge conflicts or whitespace errors detected${NC}"
    exit 1
fi

# SUCCESS
echo ""
echo "${GREEN}========================================${NC}"
echo "${GREEN}‚úÖ All pre-push checks passed!${NC}"
echo "${GREEN}Safe to push to remote${NC}"
echo "${GREEN}========================================${NC}"
echo ""
