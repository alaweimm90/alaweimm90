#!/usr/bin/env sh
# Enterprise-grade pre-commit hook
# Security and quality gates before committing

set -eu

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

printf "%b\n\n" "${BLUE}üîê Running pre-commit security and quality gates...${NC}"

# Allow skip with SKIP_HOOKS=1
if [ "${SKIP_HOOKS:-0}" = "1" ]; then
    printf "%b\n" "${YELLOW}‚ö†Ô∏è  Skipping hooks (SKIP_HOOKS=1)${NC}"
    exit 0
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)
ALL_STAGED=$(git diff --cached --name-only || true)

# 1. SECRET SCANNING
printf "%b\n" "${BLUE}üîç [1/8] Scanning for secrets...${NC}"
if command -v gitleaks >/dev/null 2>&1; then
    if gitleaks protect --staged --verbose --redact; then
        printf "%b\n" "${GREEN}‚úÖ No secrets detected${NC}"
    else
        printf "%b\n" "${RED}‚ùå BLOCKED: Secrets detected in staged files${NC}"
        printf "%b\n" "${YELLOW}   Run 'gitleaks protect --staged' for details${NC}"
        printf "%b\n" "${YELLOW}   To skip this check: SKIP_HOOKS=1 git commit${NC}"
        exit 1
    fi
else
    printf "%b\n" "${YELLOW}‚ö†Ô∏è  Gitleaks not installed - skipping secret scan${NC}"
    printf "%b\n" "${YELLOW}   Install from: https://github.com/gitleaks/gitleaks${NC}"
fi

# 2. FILE SIZE CHECK
printf "\n%b\n" "${BLUE}üì¶ [2/8] Checking file sizes...${NC}"
MAX_SIZE=5242880  # 5MB
if [ -n "$STAGED_FILES" ]; then
    while IFS= read -r file; do
        if [ -z "$file" ] || [ ! -f "$file" ]; then
            continue
        fi
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt "$MAX_SIZE" ]; then
            printf "%b\n" "${RED}‚ùå BLOCKED: $file exceeds 5MB (${size} bytes)${NC}"
            printf "%b\n" "${YELLOW}   Consider using Git LFS for large files${NC}"
            exit 1
        fi
    done <<EOF
$STAGED_FILES
EOF
fi

printf "%b\n" "${GREEN}‚úÖ File sizes OK${NC}"

# 3. TYPE SAFETY CHECK
printf "\n%b\n" "${BLUE}üìù [3/8] Type checking staged TypeScript files...${NC}"
STAGED_TS_FILES=$(printf "%s\n" "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
    echo "Checking types for:"
    echo "$STAGED_TS_FILES" | head -5
    [ $(echo "$STAGED_TS_FILES" | wc -l) -gt 5 ] && echo "... and more"

    # Use turbo to check only affected packages
    if pnpm exec turbo --version >/dev/null 2>&1; then
        if pnpm exec turbo run type-check --filter='...[HEAD]'; then
            echo "${GREEN}‚úÖ Type check passed${NC}"
        else
            echo "${RED}‚ùå BLOCKED: Type errors in staged files${NC}"
            echo "${YELLOW}   Fix type errors or use 'SKIP_HOOKS=1 git commit'${NC}"
            exit 1
        fi
    else
        echo "${YELLOW}‚ö†Ô∏è  Turbo not available - skipping type check${NC}"
    fi
else
    echo "${GREEN}‚úÖ No TypeScript files to check${NC}"
fi

# 4. LINT STAGED FILES
echo ""
echo "${BLUE}üé® [4/8] Linting staged files...${NC}"
if pnpm exec lint-staged --version >/dev/null 2>&1; then
    if pnpm exec lint-staged; then
        echo "${GREEN}‚úÖ Linting passed${NC}"
    else
        echo "${RED}‚ùå BLOCKED: Linting errors (may be auto-fixable)${NC}"
        echo "${YELLOW}   Run 'pnpm lint:fix' to auto-fix${NC}"
        exit 1
    fi
else
    echo "${YELLOW}‚ö†Ô∏è  lint-staged not installed${NC}"
fi

# 5. BANNED PATTERNS CHECK
echo ""
echo "${BLUE}üö´ [5/8] Checking for banned patterns...${NC}"

BANNED_FOUND=false
if [ -n "$STAGED_FILES" ]; then
    while IFS= read -r file; do
        if [ ! -f "$file" ]; then
            continue
        fi

        if echo "$file" | grep -qvE '(\.test\.|\.spec\.|scripts/|\.config\.)'; then
            if grep -q 'console\.\(log\|debug\)' "$file" && ! grep -q '// @allowed-console' "$file"; then
                echo "${RED}‚ùå BLOCKED: console.log found in $file${NC}"
                echo "${YELLOW}   Use proper logging or add '// @allowed-console'${NC}"
                BANNED_FOUND=true
            fi
        fi

        if echo "$file" | grep -qE '\.(ts|tsx)$'; then
            if grep -q ': any' "$file" && ! grep -q '// @allowed-any' "$file"; then
                echo "${RED}‚ùå BLOCKED: TypeScript 'any' type in $file${NC}"
                echo "${YELLOW}   Add proper typing or '// @allowed-any' with justification${NC}"
                BANNED_FOUND=true
            fi
        fi

        if grep -q 'debugger' "$file"; then
            echo "${RED}‚ùå BLOCKED: debugger statement in $file${NC}"
            BANNED_FOUND=true
        fi
    done <<EOF
$STAGED_FILES
EOF
fi

if [ "$BANNED_FOUND" = "true" ]; then
    exit 1
fi

echo "${GREEN}‚úÖ No banned patterns found${NC}"

# 6. SECURITY CONFIGURATION CHECK
echo ""
echo "${BLUE}üõ°Ô∏è  [6/8] Checking security configurations...${NC}"

if git diff --cached --name-only | grep -qE '(docker-compose|\.env\.example|Dockerfile)'; then
    echo "${YELLOW}‚ö†Ô∏è  Infrastructure files modified${NC}"
    echo "${YELLOW}   Ensure no hardcoded credentials or secrets${NC}"
fi

echo "${GREEN}‚úÖ Security configuration check complete${NC}"

# 7. TEST REQUIREMENT CHECK
echo ""
echo "${BLUE}üß™ [7/8] Checking test coverage...${NC}"

STAGED_SRC_FILES=$(printf "%s\n" "$STAGED_FILES" | grep -E 'src/.*\.(ts|tsx|js|jsx)$' | grep -v '\.test\.' || true)

if [ -n "$STAGED_SRC_FILES" ]; then
    MISSING_TESTS=""
    while IFS= read -r src_file; do
        [ -z "$src_file" ] && continue
        test_file=$(echo "$src_file" | sed 's/src/test/' | sed 's/\.\([^.]*\)$/\.test\.\1/')

        if [ ! -f "$test_file" ]; then
            test_file=$(echo "$src_file" | sed 's/\.\([^.]*\)$/\.test\.\1/')

            if [ ! -f "$test_file" ]; then
                echo "${YELLOW}‚ö†Ô∏è  No test file for $src_file${NC}"
                MISSING_TESTS="true"
            fi
        fi
    done <<EOF
$STAGED_SRC_FILES
EOF

    if [ "$MISSING_TESTS" = "true" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Some source files lack tests (warning only)${NC}"
    else
        echo "${GREEN}‚úÖ Test files present${NC}"
    fi
else
    echo "${GREEN}‚úÖ No source files to check${NC}"
fi

# 8. DEPENDENCY SYNC CHECK
echo ""
echo "${BLUE}üì¶ [8/8] Checking dependency sync...${NC}"

if printf "%s\n" "$ALL_STAGED" | grep -q 'package\.json$'; then
    echo "${YELLOW}‚ö†Ô∏è  package.json modified${NC}"

    if ! printf "%s\n" "$ALL_STAGED" | grep -q 'pnpm-lock.yaml'; then
        echo "${RED}‚ùå BLOCKED: package.json changed but pnpm-lock.yaml not staged${NC}"
        echo "${YELLOW}   Run 'pnpm install' and stage the lockfile${NC}"
        exit 1
    fi

    echo "${GREEN}‚úÖ Lockfile is staged${NC}"
else
    echo "${GREEN}‚úÖ No dependency changes${NC}"
fi

# SUCCESS
echo ""
echo "${GREEN}========================================${NC}"
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo "${GREEN}========================================${NC}"
echo ""

# Blockchain validation
if [ -d "automation/blockchain" ]; then
    echo "üîó Validating blockchain integration..."
    cd automation/blockchain && node scripts/health-check.js && cd ../..
fi
