# =============================================================================
# ORCHESTRATION INTEGRATION v1.0
# Connects prompt engine with multi-agent orchestration system
# =============================================================================

metadata:
  version: '1.0.0'
  created: '2025-12-02'
  purpose: 'Bridge between prompt engine and codebase orchestrator'

# =============================================================================
# AGENT-PROMPT MAPPING
# =============================================================================

agent_prompt_mapping:
  # Map orchestration agents to superprompts
  analyzer_agent:
    primary_prompt: 'codebase-sentinel'
    phase_focus: ['OBSERVE', 'ANALYZE']
    capabilities:
      - 'code_analysis'
      - 'pattern_detection'
      - 'smell_identification'

  simplifier_agent:
    primary_prompt: 'codebase-sentinel'
    phase_focus: ['SIMPLIFY']
    capabilities:
      - 'dead_code_removal'
      - 'complexity_reduction'
      - 'duplication_elimination'

  doc_validator_agent:
    primary_prompt: 'codebase-sentinel'
    phase_focus: ['VALIDATE']
    capabilities:
      - 'documentation_accuracy'
      - 'structure_verification'
      - 'reference_checking'

  codemap_agent:
    primary_prompt: 'architect'
    secondary_prompt: 'codebase-sentinel'
    capabilities:
      - 'structure_mapping'
      - 'dependency_graphing'
      - 'architecture_documentation'

  cross_validator_agent:
    primary_prompt: 'codebase-sentinel'
    secondary_prompt: 'security-auditor'
    phase_focus: ['CRITIQUE', 'VALIDATE']
    capabilities:
      - 'consistency_checking'
      - 'policy_enforcement'
      - 'cross_reference_validation'

  security_agent:
    primary_prompt: 'security-auditor'
    capabilities:
      - 'vulnerability_scanning'
      - 'secret_detection'
      - 'dependency_audit'

# =============================================================================
# WORKFLOW-PROMPT INTEGRATION
# =============================================================================

workflow_integration:
  # How prompts integrate with workflow phases
  codebase_audit:
    phases:
      - name: 'observe'
        prompts: ['codebase-sentinel']
        guidance_sections: ['thinking_phases.OBSERVE']

      - name: 'analyze'
        prompts: ['codebase-sentinel', 'security-auditor']
        guidance_sections:
          - 'thinking_phases.ANALYZE'
          - 'security_auditor.analysis_layers'

      - name: 'critique'
        prompts: ['codebase-sentinel']
        guidance_sections: ['thinking_phases.CRITIQUE']

      - name: 'simplify'
        prompts: ['codebase-sentinel']
        guidance_sections: ['thinking_phases.SIMPLIFY', 'laws']

      - name: 'validate'
        prompts: ['codebase-sentinel', 'security-auditor']
        guidance_sections:
          - 'thinking_phases.VALIDATE'
          - 'security_auditor.execution'

      - name: 'synthesize'
        prompts: ['codebase-sentinel']
        guidance_sections: ['thinking_phases.SYNTHESIZE']

# =============================================================================
# DYNAMIC PROMPT INJECTION
# =============================================================================

dynamic_injection:
  # How to inject prompt guidance into agent context
  strategy: 'context_prepend'

  template: |
    <superprompt-guidance>
    ## Active Superprompt: {prompt_id}
    ## Role: {role}
    ## Philosophy: {philosophy}

    ### Current Phase: {phase}
    Question to answer: {phase_question}

    ### Active Principles:
    {principles}

    ### Anti-patterns to avoid:
    {interceptors}
    </superprompt-guidance>

  context_limits:
    max_guidance_tokens: 2000
    preserve_task_context: true
    summarize_if_exceeds: true

# =============================================================================
# FEEDBACK LOOP
# =============================================================================

feedback_loop:
  # How orchestration outcomes feed back to prompt engine
  on_workflow_complete:
    - action: 'extract_metrics'
      metrics:
        - 'task_success_rate'
        - 'phase_durations'
        - 'error_counts'

    - action: 'map_to_prompts'
      mapping: 'agent_prompt_mapping'

    - action: 'record_outcome'
      endpoint: 'prompt_engine.record_outcome'

  on_agent_error:
    - action: 'classify_error'
      classifier: 'error_category_mapper'

    - action: 'adjust_prompt_weight'
      adjustment: 'decrease_on_failure'

    - action: 'log_for_analysis'
      destination: 'learning/error-analysis.jsonl'

# =============================================================================
# HOOKS
# =============================================================================

hooks:
  pre_workflow:
    - name: 'select_prompts'
      action: 'prompt_engine.select'
      input: 'workflow_description'
      output: 'active_prompts'

    - name: 'inject_guidance'
      action: 'inject_prompt_guidance'
      input: 'active_prompts'
      target: 'agent_contexts'

  post_phase:
    - name: 'evaluate_phase'
      action: 'assess_phase_success'

    - name: 'adapt_prompts'
      action: 'adjust_for_next_phase'
      condition: 'if_underperforming'

  post_workflow:
    - name: 'record_learning'
      action: 'prompt_engine.record_outcome'
      input: 'workflow_metrics'

    - name: 'generate_insights'
      action: 'analyze_prompt_effectiveness'
      output: 'learning_report'
