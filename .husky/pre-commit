#!/bin/bash

echo "ðŸš¨ META GOVERNANCE: Pre-commit hook activated"

# Meta governance repository - policy and documentation checks only

# 1. Security scan (if package.json exists)
if [ -f "package.json" ]; then
    echo "ðŸ”’ Running security scan..."
    npm audit --audit-level=moderate
    if [ $? -ne 0 ]; then
        echo "âš ï¸  WARNING: Security vulnerabilities found"
        echo "Run 'npm audit fix' to resolve"
        # Don't block - governance repo may not have immediate fix
    fi
fi

# 2. Check for secrets in committed files
echo "ðŸ”‘ Scanning for secrets..."
if git diff --cached --name-only | xargs grep -E "(password|secret|api[_-]*key|token)" 2>/dev/null | grep -v ".metaHub/"; then
    echo "âš ï¸  WARNING: Potential secrets found in staged files"
    echo "Review carefully before committing"
    # Don't block - may be intentional documentation
fi

# 3. Validate YAML files (workflows and configs)
echo "ðŸ“‹ Validating YAML files..."
for file in $(git diff --cached --name-only | grep -E '\.(yml|yaml)$'); do
    if [ -f "$file" ]; then
        # Basic YAML syntax check (if yq or python available)
        if command -v python &> /dev/null; then
            python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo "âŒ COMMIT BLOCKED: Invalid YAML in $file"
                exit 1
            fi
        fi
    fi
done

# 4. Validate markdown files (if markdownlint available)
if command -v markdownlint &> /dev/null; then
    echo "ðŸ“ Validating Markdown files..."
    git diff --cached --name-only | grep -E '\.md$' | xargs markdownlint 2>/dev/null || true
fi

echo "âœ… META GOVERNANCE CHECKS PASSED - Commit allowed"
echo "ðŸŽ‰ Governance policies and documentation are valid"
