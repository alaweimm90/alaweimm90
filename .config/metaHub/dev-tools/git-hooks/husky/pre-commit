#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Governance Pre-commit Hook
# Enforces all governance standards before allowing commits

echo "ğŸ›¡ï¸ Running Governance Pre-commit Checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
FAILED=0

# 1. Check repository structure
echo "ğŸ“ Checking repository structure..."
node .governance/validators/repository-validator.js --quick
if [ $? -ne 0 ]; then
    echo "${RED}âŒ Repository structure validation failed${NC}"
    FAILED=1
else
    echo "${GREEN}âœ… Repository structure valid${NC}"
fi

# 2. Check naming conventions
echo "ğŸ“ Checking naming conventions..."
files_changed=$(git diff --cached --name-only)
for file in $files_changed; do
    # Check file naming (kebab-case)
    filename=$(basename "$file")
    name_without_ext="${filename%.*}"

    # Skip exceptions
    if [[ "$filename" =~ ^(README|LICENSE|CHANGELOG|SECURITY|CONTRIBUTING|CODE_OF_CONDUCT)\.md$ ]]; then
        continue
    fi

    if ! [[ "$name_without_ext" =~ ^[a-z0-9-]+$ ]]; then
        echo "${YELLOW}âš ï¸  File naming violation: $file${NC}"
        echo "    Should be kebab-case: $(echo $name_without_ext | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')"
        FAILED=1
    fi
done

# 3. Run linting
echo "ğŸ” Running linters..."
if command -v eslint &> /dev/null; then
    npx eslint $files_changed --max-warnings 0
    if [ $? -ne 0 ]; then
        echo "${RED}âŒ ESLint found issues${NC}"
        FAILED=1
    else
        echo "${GREEN}âœ… ESLint passed${NC}"
    fi
fi

# 4. Run Prettier
echo "ğŸ’… Checking formatting..."
if command -v prettier &> /dev/null; then
    npx prettier --check $files_changed
    if [ $? -ne 0 ]; then
        echo "${YELLOW}âš ï¸  Formatting issues found. Run: npx prettier --write <files>${NC}"
        FAILED=1
    else
        echo "${GREEN}âœ… Formatting check passed${NC}"
    fi
fi

# 5. Check for secrets
echo "ğŸ”’ Scanning for secrets..."
for file in $files_changed; do
    # Skip binary files
    if file --mime-type "$file" | grep -q "text/"; then
        # Check for common secret patterns
        if grep -E "(api[_-]?key|password|secret|token|private[_-]?key)\s*=\s*[\"'][^\"']+[\"']" "$file" > /dev/null 2>&1; then
            echo "${RED}âŒ Potential secret detected in: $file${NC}"
            echo "    Move secrets to environment variables"
            FAILED=1
        fi
    fi
done

if [ $FAILED -eq 0 ]; then
    echo "${GREEN}âœ… No secrets detected${NC}"
fi

# 6. Check TypeScript types (if applicable)
if [ -f "tsconfig.json" ]; then
    echo "ğŸ“˜ Checking TypeScript types..."
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "${RED}âŒ TypeScript type errors found${NC}"
        FAILED=1
    else
        echo "${GREEN}âœ… TypeScript types valid${NC}"
    fi
fi

# 7. Run tests for changed files
echo "ğŸ§ª Running tests..."
# Find test files for changed source files
test_files=""
for file in $files_changed; do
    if [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ "$file" =~ ^src/ ]]; then
        test_file="${file/src/tests}"
        test_file="${test_file%.*}.test${file##*.}"
        if [ -f "$test_file" ]; then
            test_files="$test_files $test_file"
        fi
    fi
done

if [ -n "$test_files" ]; then
    npm test -- $test_files
    if [ $? -ne 0 ]; then
        echo "${RED}âŒ Tests failed${NC}"
        FAILED=1
    else
        echo "${GREEN}âœ… Tests passed${NC}"
    fi
else
    echo "${YELLOW}â„¹ï¸  No tests to run${NC}"
fi

# 8. Check documentation
echo "ğŸ“š Checking documentation..."
docs_needed=0
for file in $files_changed; do
    if [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]]; then
        # Check if file has JSDoc/TSDoc comments
        if ! grep -q "^/\*\*\|///" "$file" 2>/dev/null; then
            echo "${YELLOW}âš ï¸  Missing documentation: $file${NC}"
            docs_needed=1
        fi
    fi
done

if [ $docs_needed -eq 0 ]; then
    echo "${GREEN}âœ… Documentation check passed${NC}"
fi

# 9. Update file tracking
echo "ğŸ“Š Updating file tracking..."
node .governance/registry/file-tracking-system.js --update-only
if [ $? -eq 0 ]; then
    echo "${GREEN}âœ… File tracking updated${NC}"
fi

# 10. Validate commit message
if [ -f ".gitmessage" ]; then
    # Will be checked by commit-msg hook
    echo "${GREEN}âœ… Commit message will be validated${NC}"
fi

# Final status
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $FAILED -ne 0 ]; then
    echo "${RED}âŒ GOVERNANCE CHECKS FAILED${NC}"
    echo ""
    echo "Please fix the issues above before committing."
    echo "Run the following to auto-fix some issues:"
    echo "  npm run lint:fix"
    echo "  npm run format"
    echo "  node .governance/validators/repository-validator.js --fix"
    exit 1
else
    echo "${GREEN}âœ… ALL GOVERNANCE CHECKS PASSED${NC}"
    echo ""
    echo "Your commit is compliant with governance standards!"
fi

exit 0