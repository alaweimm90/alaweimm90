name: Structure Compliance Nightly

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate compliance report
        shell: pwsh
        run: |
          $json = & ./.tools/validate-structure.ps1
          $data = $json | ConvertFrom-Json
          $timestamp = (Get-Date).ToString('yyyy-MM-ddTHH:mm:ssZ')
          $report = [PSCustomObject]@{
            timestamp = $timestamp
            compliance = $data.compliance
            checks = $data.checks
            extraHidden = $data.extraHidden
          }
          $report | ConvertTo-Json -Depth 6 | Set-Content -Path structure-compliance.json -Encoding UTF8
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: structure-compliance-${{ github.run_id }}
          path: structure-compliance.json
      - name: Create or update compliance issue when below threshold
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('structure-compliance.json','utf8'));
            const threshold = 95;
            const { owner, repo } = context.repo;
            if ((data.compliance || 0) >= threshold) {
              const title = 'Structure Compliance';
              const search = await github.rest.search.issuesAndPullRequests({
                q: `repo:${owner}/${repo} is:issue in:title "${title}" state:open`
              });
              if (search.data.items.length > 0) {
                const issue_number = search.data.items[0].number;
                const issue = await github.rest.issues.get({ owner, repo, issue_number });
                try {
                  await github.graphql(
                    `mutation($issueId: ID!) { unpinIssue(input: { issueId: $issueId }) { clientMutationId } }`,
                    { issueId: issue.data.node_id }
                  );
                } catch (e) { core.info(`Unpin skipped: ${e.message}`); }
                await github.rest.issues.update({ owner, repo, issue_number, state: 'closed' });
                core.info(`Closed and unpinned compliance issue #${issue_number}`);
              } else {
                core.info(`Compliance ${data.compliance} >= ${threshold}, no issue present.`);
              }
            } else {
              const title = 'Structure Compliance';
              const body = [
                `Compliance: ${data.compliance}`,
                '',
                'Checks:',
                ...(Array.isArray(data.checks) ? data.checks.map(c => `- ${c.check}: ${c.ok}`) : []),
                '',
                'Extra hidden:',
                ...(Array.isArray(data.extraHidden) && data.extraHidden.length ? data.extraHidden.map(x => `- ${x}`) : ['- none']),
                '',
                `Timestamp: ${data.timestamp || new Date().toISOString()}`
              ].join('\n');

              const search = await github.rest.search.issuesAndPullRequests({
                q: `repo:${owner}/${repo} is:issue in:title "${title}" state:open`
              });
              let issue_number;
              if (search.data.items.length > 0) {
                issue_number = search.data.items[0].number;
                await github.rest.issues.update({ owner, repo, issue_number, title, body });
              } else {
                const created = await github.rest.issues.create({ owner, repo, title, body });
                issue_number = created.data.number;
              }
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['compliance','governance'] });
              const issue = await github.rest.issues.get({ owner, repo, issue_number });
              await github.graphql(
                `mutation($issueId: ID!) { pinIssue(input: { issueId: $issueId }) { clientMutationId } }`,
                { issueId: issue.data.node_id }
              );
            }
      - name: Fail if compliance below threshold
        shell: pwsh
        run: |
          $data = Get-Content -Raw structure-compliance.json | ConvertFrom-Json
          if($data.compliance -lt 95){ Write-Error "Compliance below threshold (95)" }
