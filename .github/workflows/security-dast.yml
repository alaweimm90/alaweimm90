name: DAST - Dynamic Security Testing

on:
  schedule:
    - cron: '0 3 * * *' # Daily DAST scan at 3 AM UTC
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for DAST'
        required: true
        default: 'http://localhost:3000'

env:
  OWASP_ZAP_VERSION: 'latest'
  SEVERITY_THRESHOLD: 'medium'

jobs:
  # OWASP ZAP Dynamic Application Security Testing
  owasp-zap-scan:
    runs-on: ubuntu-latest
    name: DAST - OWASP ZAP Scanning
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        continue-on-error: true

      - name: Start test server
        run: npm run dev &
        timeout-minutes: 2
        continue-on-error: true

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done'
        continue-on-error: true

      - name: Run OWASP ZAP Docker scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-scan-report
          path: |
            report_html.html
            report_md.md
          retention-days: 30

  # OWASP Juice Shop Vulnerability Testing (Optional)
  juice-shop-test:
    runs-on: ubuntu-latest
    name: DAST - Juice Shop Vulnerability Tests
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Juice Shop automated tests
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OWASP ZAP CLI
        run: |
          docker pull owasp/zap2docker-stable

      - name: Run comprehensive ZAP scan
        run: |
          docker run -t owasp/zap2docker-stable zap-baseline.py \
            -t http://localhost:3000 \
            -J zap-report.json || true

      - name: Parse and check vulnerabilities
        run: |
          if [ -f zap-report.json ]; then
            # Extract high/critical vulnerabilities
            HIGH_VULN=$(jq '[.site[].alerts[] | select(.riskcode >= 2)] | length' zap-report.json)
            echo "High/Critical Vulnerabilities: $HIGH_VULN"
            if [ "$HIGH_VULN" -gt 0 ]; then
              jq '.site[].alerts[] | select(.riskcode >= 2) | {name: .name, risk: .riskdesc}' zap-report.json
              exit 1
            fi
          fi

  # API Security Testing
  api-security-test:
    runs-on: ubuntu-latest
    name: DAST - API Security Testing
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install API security tools
        run: |
          pip install requests pyyaml pytest

      - name: Run API security tests
        run: |
          python -m pytest tests/security/api_tests.py -v || true
        continue-on-error: true

  # Burp Suite Community Scan (Optional)
  burp-community-scan:
    runs-on: ubuntu-latest
    name: DAST - Burp Suite Community
    if: false # Set to true when ready to enable
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Burp Suite Community
        run: |
          wget https://portswigger.net/burp/releases/download/burp-community-2024.x.x.jar \
            -O burp.jar || echo "Could not download Burp Suite"

      - name: Run Burp Suite scan
        run: |
          if [ -f burp.jar ]; then
            java -jar burp.jar --help || true
          fi
        continue-on-error: true

  # Nuclei Template-based Vulnerability Scanning
  nuclei-scan:
    runs-on: ubuntu-latest
    name: DAST - Nuclei Vulnerability Scanning
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Nuclei
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        continue-on-error: true

      - name: Update Nuclei templates
        run: |
          nuclei -update-templates || true
        continue-on-error: true

      - name: Run Nuclei scans
        run: |
          if command -v nuclei &> /dev/null; then
            nuclei -l targets.txt -o nuclei-report.json -json || true
          fi
        continue-on-error: true

      - name: Upload Nuclei results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: nuclei-report
          path: nuclei-report.json
        continue-on-error: true

  # Web Security Testing Report
  dast-report:
    runs-on: ubuntu-latest
    name: DAST Results Summary
    needs: [owasp-zap-scan, api-security-test]
    if: always()
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Download ZAP report
        uses: actions/download-artifact@v3
        with:
          name: zap-scan-report
        continue-on-error: true

      - name: Generate DAST summary
        run: |
          echo "## DAST Scan Summary" > dast-summary.md
          echo "" >> dast-summary.md
          echo "Date: $(date)" >> dast-summary.md
          echo "" >> dast-summary.md
          if [ -f report_md.md ]; then
            cat report_md.md >> dast-summary.md
          else
            echo "No ZAP report generated" >> dast-summary.md
          fi
          cat dast-summary.md

      - name: Upload DAST summary
        uses: actions/upload-artifact@v3
        with:
          name: dast-summary
          path: dast-summary.md
