name: Reusable OPA Policy Gate

on:
  workflow_call:
    inputs:
      policy-path:
        description: Path to OPA policies
        required: false
        default: .metaHub/policies
        type: string

jobs:
  opa-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OPA
        continue-on-error: true
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_x86_64
          chmod +x opa
          sudo mv opa /usr/local/bin/
          opa version

      - name: Evaluate OPA policies
        continue-on-error: true
        run: |
          echo "## OPA Policy Evaluation" >> $GITHUB_STEP_SUMMARY
          if [ -d "${{ inputs.policy-path }}" ]; then
            echo "Found policies at: ${{ inputs.policy-path }}" >> $GITHUB_STEP_SUMMARY
            echo "OPA policies available (warning-only mode)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy path not found: ${{ inputs.policy-path }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Policy summary
        if: always()
        run: |
          echo "## Policy Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "Mode: Warning-only (non-blocking)" >> $GITHUB_STEP_SUMMARY
