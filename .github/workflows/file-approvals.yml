name: File Approvals Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce approvals for large deletions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const cfg = JSON.parse(fs.readFileSync('config/file-management.json','utf8'));
            const thresholdMB = cfg.approvals.threshold_mb;
            const label = cfg.approvals.level_label;
            const pr = context.payload.pull_request;
            const labels = (pr.labels||[]).map(l=>l.name);
            const files = await github.rest.pulls.listFiles({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number });
            let requires = false;
            for (const f of files.data) {
              if (f.status === 'removed' && f.changes && f.changes > thresholdMB*1024*1024) { requires = true; break; }
            }
            if (requires && !labels.includes(label)) {
              core.setFailed(`Missing ${label} label for large file deletions (> ${thresholdMB} MB)`);
            }
