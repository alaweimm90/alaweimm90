name: CI - Matrix Build with Intelligent Caching

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: 127.0.0.1:5000
  # Enable BuildKit for better caching
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Detect which services changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: set-matrix
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Initialize services array
          SERVICES='[]'

          # Check for changes in specific service directories
          if echo "$CHANGED_FILES" | grep -qE '^.config/organizations/SimCore/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["simcore"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^.config/organizations/repz/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["repz"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^.config/organizations/benchbarrier/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["benchbarrier"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^.config/organizations/Attributa/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["attributa"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^.config/organizations/mag-logic/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["mag-logic"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^apps/ai-agent-demo/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["ai-agent-demo"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^alaweimm90/automation/api-gateway/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["api-gateway"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^alaweimm90/automation/dashboard/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["dashboard"]')
          fi

          if echo "$CHANGED_FILES" | grep -qE '^alaweimm90/automation/healthcare/'; then
            SERVICES=$(echo "$SERVICES" | jq '. + ["healthcare"]')
          fi

          # If docker-compose.yml or Dockerfiles changed, rebuild all
          if echo "$CHANGED_FILES" | grep -qE '(docker-compose\.yml|Dockerfile)'; then
            SERVICES='["simcore", "repz", "benchbarrier", "attributa", "mag-logic", "ai-agent-demo", "api-gateway", "dashboard", "healthcare"]'
          fi

          # Remove duplicates
          SERVICES=$(echo "$SERVICES" | jq 'unique')

          # Check if we have any services to build
          HAS_CHANGES=$(echo "$SERVICES" | jq 'length > 0')

          echo "Services to build: $SERVICES"
          echo "matrix=$SERVICES" >> $GITHUB_OUTPUT
          echo "has-changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # Build and scan containers
  build-and-scan:
    name: Build & Scan ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'

    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        run: |
          echo "Building ${{ matrix.service }}..."
          docker compose build ${{ matrix.service }} \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
          category: trivy-${{ matrix.service }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ matrix.service }}:latest
          format: spdx-json
          output-file: sbom-${{ matrix.service }}.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.service }}
          path: sbom-${{ matrix.service }}.spdx.json
          retention-days: 90

      - name: Tag and push to local registry (simulation)
        run: |
          # Tag with git SHA
          GIT_SHA=$(git rev-parse --short HEAD)
          docker tag ${{ matrix.service }}:latest ${{ matrix.service }}:git-${GIT_SHA}

          echo "Tagged as: ${{ matrix.service }}:git-${GIT_SHA}"
          # In production, push to 127.0.0.1:5000
          # docker push ${REGISTRY}/${{ matrix.service }}:git-${GIT_SHA}

      - name: Service health check
        run: |
          echo "Starting health check for ${{ matrix.service }}..."
          # Start the service
          docker compose up -d ${{ matrix.service }}

          # Wait for health check
          timeout 60 bash -c 'until docker compose ps ${{ matrix.service }} | grep -q healthy; do sleep 2; done' || {
            echo "Health check failed!"
            docker compose logs ${{ matrix.service }}
            exit 1
          }

          echo "âœ… Health check passed!"
          docker compose down

  # Hadolint Dockerfile linting
  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "**/Dockerfile"
          recursive: true
          failure-threshold: warning
          format: sarif
          output-file: hadolint-results.sarif

      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          category: hadolint

  # Node.js tests with caching
  test-nodejs:
    name: Test Node.js Services
    runs-on: ubuntu-latest
    needs: detect-changes

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm run lint || echo "No lint script defined"

      - name: Run tests
        run: pnpm run test || echo "No test script defined"

      - name: Build packages
        run: pnpm run build || echo "No build script defined"

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-scan, lint-dockerfiles, test-nodejs]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Services" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.detect-changes.outputs.matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Detect Changes: ${{ needs.detect-changes.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Scan: ${{ needs.build-and-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lint Dockerfiles: ${{ needs.lint-dockerfiles.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Node.js: ${{ needs.test-nodejs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
