name: Service Scorecard

on:
  push:
    branches: [master, main]
    paths:
      - '.metaHub/service-catalog.json'
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  actions: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate Scorecard
        run: |
          mkdir -p .metaHub/security/scorecard/history
          ts=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          out=".metaHub/security/scorecard/history/scorecard-${ts}.md"
          echo "# Service Scorecard (${ts})" > "$out"
          echo "" >> "$out"
          jq -r '
            .services[] | 
            "## " + (.name // "unknown") + "\n" +
            "- image: " + (.image // "n/a") + "\n" +
            "- port: " + ((.port | tostring) // "n/a") + "\n" +
            "- health: " + (.health // "n/a") + "\n" +
            "- domain: " + ((.domain // "n/a") | tostring) + "\n" +
            "- slo.availability: " + ((.slo.availability // "missing") | tostring) + "\n" +
            "- slo.latency: " + ((.slo.latency // "missing") | tostring) + "\n" 
          ' .metaHub/service-catalog.json >> "$out"

      - name: Upload Scorecard
        uses: actions/upload-artifact@v4
        with:
          name: service-scorecard-${{ github.sha }}
          path: .metaHub/security/scorecard/history/
          retention-days: 30

