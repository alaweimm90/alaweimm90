name: Governance Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch:

jobs:
  structure-validation:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install glob

      - name: Run structure validation
        run: |
          node .governance/validators/repository-validator.js
        continue-on-error: false

      - name: Auto-fix violations (if possible)
        if: github.event_name == 'pull_request'
        run: |
          node .governance/validators/repository-validator.js --fix
          if [[ -n $(git status -s) ]]; then
            git config --local user.email "governance-bot@github-actions"
            git config --local user.name "Governance Bot"
            git add .
            git commit -m "Auto-fix: Repository structure violations"
            git push
          fi

      - name: Upload validation report
        uses: actions/upload-artifact@v3
        with:
          name: structure-validation-report
          path: .governance/reports/validation-*.json
          retention-days: 30

  naming-conventions:
    name: Check Naming Conventions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check file naming conventions
        run: |
          # Check for files that don't follow kebab-case
          files_with_issues=""
          while IFS= read -r file; do
            filename=$(basename "$file")
            name_without_ext="${filename%.*}"

            # Skip exceptions
            if [[ "$filename" =~ ^(README|LICENSE|CHANGELOG|SECURITY|CONTRIBUTING|CODE_OF_CONDUCT)\.md$ ]]; then
              continue
            fi

            # Check if follows kebab-case
            if ! [[ "$name_without_ext" =~ ^[a-z0-9-]+$ ]]; then
              files_with_issues="${files_with_issues}\n  - ${file}"
            fi
          done < <(find . -type f -name "*.*" ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./dist/*" ! -path "./build/*")

          if [ -n "$files_with_issues" ]; then
            echo "âŒ Files violating naming convention:${files_with_issues}"
            exit 1
          else
            echo "âœ… All files follow naming conventions"
          fi

      - name: Check directory naming conventions
        run: |
          dirs_with_issues=""
          while IFS= read -r dir; do
            dirname=$(basename "$dir")

            # Check if follows lowercase convention
            if ! [[ "$dirname" =~ ^[a-z0-9-]+$ ]]; then
              dirs_with_issues="${dirs_with_issues}\n  - ${dir}"
            fi
          done < <(find . -type d ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./dist/*" ! -path "./build/*" ! -path ".")

          if [ -n "$dirs_with_issues" ]; then
            echo "âŒ Directories violating naming convention:${dirs_with_issues}"
            exit 1
          else
            echo "âœ… All directories follow naming conventions"
          fi

  linting-and-formatting:
    name: Linting & Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -D eslint prettier eslint-config-prettier

      - name: Run ESLint
        run: npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,md,yml,yaml}"
        continue-on-error: true

      - name: Auto-fix formatting (PR only)
        if: github.event_name == 'pull_request'
        run: |
          npx eslint . --ext .js,.jsx,.ts,.tsx --fix
          npx prettier --write "**/*.{js,jsx,ts,tsx,json,md,yml,yaml}"
          if [[ -n $(git status -s) ]]; then
            git config --local user.email "governance-bot@github-actions"
            git config --local user.name "Governance Bot"
            git add .
            git commit -m "Auto-fix: Linting and formatting issues"
            git push
          fi

  type-checking:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest
    if: contains(github.repository, 'typescript') || contains(github.repository, 'ts')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install TypeScript
        run: npm install -D typescript

      - name: Run type checking
        run: npx tsc --noEmit --strict
        continue-on-error: false

  security-scanning:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for exposed secrets in code
        run: |
          # Custom secret detection patterns
          patterns=(
            "api[_-]?key.*=.*['\"][^'\"]{20,}['\"]"
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "secret.*=.*['\"][^'\"]{20,}['\"]"
            "token.*=.*['\"][^'\"]{20,}['\"]"
            "private[_-]?key.*=.*['\"][^'\"]{20,}['\"]"
          )

          found_secrets=false
          for pattern in "${patterns[@]}"; do
            if grep -r -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git; then
              found_secrets=true
            fi
          done

          if [ "$found_secrets" = true ]; then
            echo "âŒ Potential secrets found in code!"
            exit 1
          else
            echo "âœ… No secrets detected"
          fi

  documentation-check:
    name: Documentation Completeness Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required documentation files
        run: |
          required_files=("README.md" "LICENSE" "SECURITY.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md")
          missing_files=""

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files="${missing_files}\n  - ${file}"
            fi
          done

          if [ -n "$missing_files" ]; then
            echo "âŒ Missing required documentation:${missing_files}"
            exit 1
          else
            echo "âœ… All required documentation present"
          fi

      - name: Check README sections
        run: |
          if [ -f "README.md" ]; then
            required_sections=("Installation" "Usage" "Configuration" "API" "Contributing" "License")
            missing_sections=""

            for section in "${required_sections[@]}"; do
              if ! grep -q "## $section" README.md; then
                missing_sections="${missing_sections}\n  - ${section}"
              fi
            done

            if [ -n "$missing_sections" ]; then
              echo "âš ï¸ Missing README sections:${missing_sections}"
            else
              echo "âœ… README has all required sections"
            fi
          fi

      - name: Check for API documentation
        run: |
          # Check if source files have documentation
          total_files=$(find src -name "*.js" -o -name "*.ts" 2>/dev/null | wc -l || echo 0)
          if [ "$total_files" -gt 0 ]; then
            documented_files=$(grep -l "/\*\*\|///" src/**/*.{js,ts} 2>/dev/null | wc -l || echo 0)
            coverage=$((documented_files * 100 / total_files))

            echo "ðŸ“Š Documentation coverage: ${coverage}%"

            if [ $coverage -lt 80 ]; then
              echo "âŒ Documentation coverage below 80% threshold"
              exit 1
            fi
          fi

  file-tracking:
    name: File Tracking & Lifecycle Management
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run file tracking scan
        run: |
          node .governance/registry/file-tracking-system.js

      - name: Archive old files (scheduled only)
        if: github.event_name == 'schedule'
        run: |
          # Archive files older than 90 days
          find . -type f -mtime +90 ! -path "./node_modules/*" ! -path "./.git/*" -exec echo "Archiving: {}" \;

      - name: Generate tracking report
        run: |
          echo "ðŸ“Š File Tracking Report generated"
          ls -la .governance/registry/tracking.json

      - name: Upload tracking report
        uses: actions/upload-artifact@v3
        with:
          name: file-tracking-report
          path: .governance/registry/tracking.json
          retention-days: 30

  compliance-report:
    name: Generate Compliance Report
    runs-on: ubuntu-latest
    needs:
      [
        structure-validation,
        naming-conventions,
        linting-and-formatting,
        security-scanning,
        documentation-check,
      ]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate compliance summary
        run: |
          cat > .governance/reports/compliance-summary.md << EOF
          # Governance Compliance Report
          Date: $(date)
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}

          ## Check Results

          | Check | Status |
          |-------|--------|
          | Structure Validation | ${{ needs.structure-validation.result }} |
          | Naming Conventions | ${{ needs.naming-conventions.result }} |
          | Linting & Formatting | ${{ needs.linting-and-formatting.result }} |
          | Security Scanning | ${{ needs.security-scanning.result }} |
          | Documentation Check | ${{ needs.documentation-check.result }} |

          ## Actions Taken
          - Auto-fix applied where possible
          - Reports generated and archived
          - Notifications sent to maintainers

          ## Next Steps
          - Review and address any failures
          - Update documentation as needed
          - Schedule follow-up review
          EOF

      - name: Create issue for failures
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Governance Compliance Failures Detected',
              body: `Governance checks have failed. Please review the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) and address the issues.`,
              labels: ['governance', 'compliance', 'high-priority']
            });
            console.log(`Created issue #${issue.number}`);

      - name: Upload compliance report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-summary
          path: .governance/reports/compliance-summary.md
          retention-days: 90

  audit-trail:
    name: Create Audit Trail
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Create audit entry
        run: |
          mkdir -p .governance/audit

          cat > .governance/audit/$(date +%Y%m%d-%H%M%S).json << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "event": "governance-check",
            "trigger": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "status": "${{ job.status }}"
          }
          EOF

      - name: Commit audit trail (scheduled only)
        if: github.event_name == 'schedule'
        run: |
          git config --local user.email "governance-bot@github-actions"
          git config --local user.name "Governance Bot"
          git add .governance/audit/
          git commit -m "Audit: Governance check completed" || echo "No changes to commit"
          git push || echo "No changes to push"
