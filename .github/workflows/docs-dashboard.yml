name: Docs Dashboard

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Compute compliance
        run: |
          set -euo pipefail
          get_scope() { find . -type f \( -name package.json -o -name pyproject.toml \) -print0 | xargs -0 -n1 dirname | sort -u; }
          ok=0; total=0
          echo '[' > details.json
          while IFS= read -r dir; do
            total=$((total+1))
            miss=0; unauth=0
            for f in README.md CONTRIBUTING.md CHANGELOG.md; do [ -f "$dir/$f" ] || miss=$((miss+1)); done
            for f in $(ls -1 "$dir" 2>/dev/null | grep -E '\.md$' || true); do
              case "$f" in README.md|CONTRIBUTING.md|CHANGELOG.md|SPECIFICATIONS.md|DESIGN.md) :;; *) unauth=$((unauth+1));; esac
            done
            viol=$((miss+unauth))
            if [ "$viol" -eq 0 ]; then ok=$((ok+1)); else echo "{\"folder\":\"$dir\",\"missing\":$miss,\"unauthorized\":$unauth}" >> details.json; echo ',' >> details.json; fi
          done < <(get_scope)
          sed -i '$ s/,$//' details.json; echo ']' >> details.json
          pct=0
          if [ "$total" -gt 0 ]; then pct=$((100*ok/total)); fi
          jq -n --argjson compliance $pct --argjson total $total --argjson passing $ok --argjson details "$(cat details.json)" '{generatedAt:(now|todate),compliance:$compliance,totalFolders:$total,passing:$passing,problems:$details}' > docs-dashboard.json
      - name: Upload dashboard
        uses: actions/upload-artifact@v4
        with:
          name: docs-dashboard
          path: docs-dashboard.json
      - name: Push dashboard to history branch
        run: |
          set -euo pipefail
          ts="$(date +%Y%m%d%H%M%S)"
          mkdir -p docs-history
          cp docs-dashboard.json docs-history/dashboard-$ts.json
          git checkout -b docs/dashboard-history || git checkout docs/dashboard-history
          git add docs-history/dashboard-$ts.json
          git commit -m "docs: dashboard snapshot $ts" || echo "No changes"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: docs/dashboard-history
          title: 'Docs: Dashboard snapshot'
          commit-message: 'docs: dashboard snapshot'
          labels: docs-dashboard
