---
# SuperTool Ansible Deployment Playbook
# Deploys SuperTool application to target servers

- name: Deploy SuperTool
  hosts: "{{ target_hosts | default('supertool_servers') }}"
  become: yes
  gather_facts: yes

  vars:
    app_name: supertool
    app_version: "{{ version | default('latest') }}"
    app_environment: "{{ environment | default('production') }}"
    container_image: "{{ image | default('ghcr.io/username/supertool') }}"
    container_port: 8080
    host_port: 8080
    app_dir: /opt/supertool
    config_dir: /etc/supertool
    log_dir: /var/log/supertool
    data_dir: /var/lib/supertool

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - app_version is defined
          - app_environment is defined
        fail_msg: "Required variables not defined. Set version and environment."

    - name: Display deployment information
      debug:
        msg:
          - "Deploying SuperTool"
          - "Version: {{ app_version }}"
          - "Environment: {{ app_environment }}"
          - "Image: {{ container_image }}:{{ app_version }}"
          - "Target: {{ inventory_hostname }}"

  tasks:
    # Directory Setup
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ app_dir }}"
        - "{{ config_dir }}"
        - "{{ log_dir }}"
        - "{{ data_dir }}"

    # Docker Installation
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker
      block:
        - name: Install Docker prerequisites
          apt:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present
            update_cache: yes
          when: ansible_os_family == "Debian"

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          when: ansible_os_family == "Debian"

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
          when: ansible_os_family == "Debian"

        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present
            update_cache: yes
          when: ansible_os_family == "Debian"

        - name: Start and enable Docker
          systemd:
            name: docker
            state: started
            enabled: yes
      when: docker_check.rc != 0

    # Pull Docker Image
    - name: Pull SuperTool Docker image
      docker_image:
        name: "{{ container_image }}"
        tag: "{{ app_version }}"
        source: pull
        force_source: yes
      register: image_pull
      retries: 3
      delay: 5

    - name: Verify image pulled successfully
      debug:
        msg: "Image {{ container_image }}:{{ app_version }} pulled successfully"
      when: image_pull is succeeded

    # Stop Existing Container
    - name: Stop existing SuperTool container
      docker_container:
        name: "{{ app_name }}"
        state: stopped
      ignore_errors: yes

    - name: Remove existing SuperTool container
      docker_container:
        name: "{{ app_name }}"
        state: absent
      ignore_errors: yes

    # Deploy New Container
    - name: Deploy SuperTool container
      docker_container:
        name: "{{ app_name }}"
        image: "{{ container_image }}:{{ app_version }}"
        state: started
        restart_policy: always
        published_ports:
          - "{{ host_port }}:{{ container_port }}"
        env:
          NODE_ENV: "{{ app_environment }}"
          LOG_LEVEL: "{{ log_level | default('info') }}"
        volumes:
          - "{{ log_dir }}:/app/logs"
          - "{{ data_dir }}:/app/data"
        healthcheck:
          test: ["CMD", "node", "-e", "console.log('healthy')"]
          interval: 30s
          timeout: 5s
          retries: 3
          start_period: 40s
        log_driver: json-file
        log_options:
          max-size: "10m"
          max-file: "3"
        labels:
          app: "{{ app_name }}"
          version: "{{ app_version }}"
          environment: "{{ app_environment }}"
          deployed_by: ansible
          deployed_at: "{{ ansible_date_time.iso8601 }}"
      register: container_deploy

    # Health Check
    - name: Wait for container to be healthy
      wait_for:
        host: localhost
        port: "{{ host_port }}"
        delay: 5
        timeout: 60
        state: started
      when: container_deploy is succeeded

    - name: Verify container is running
      docker_container_info:
        name: "{{ app_name }}"
      register: container_info

    - name: Display container status
      debug:
        msg:
          - "Container: {{ container_info.container.Name }}"
          - "Status: {{ container_info.container.State.Status }}"
          - "Health: {{ container_info.container.State.Health.Status | default('N/A') }}"
          - "Started: {{ container_info.container.State.StartedAt }}"

    # Cleanup Old Images
    - name: Remove old Docker images
      docker_prune:
        images: yes
        images_filters:
          dangling: false
          until: 24h

  post_tasks:
    - name: Deployment summary
      debug:
        msg:
          - "==================================================="
          - "SuperTool Deployment Complete!"
          - "==================================================="
          - "Version: {{ app_version }}"
          - "Environment: {{ app_environment }}"
          - "Access URL: http://{{ ansible_default_ipv4.address }}:{{ host_port }}"
          - "Logs: {{ log_dir }}"
          - "==================================================="

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted
