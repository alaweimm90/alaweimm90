---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: supertool-production
  namespace: flux-system
spec:
  interval: 10m0s
  timeout: 5m0s
  retryInterval: 2m0s

  # Source reference
  sourceRef:
    kind: GitRepository
    name: supertool

  # Path to Kustomize overlay
  path: ./devops/kubernetes/kustomize/overlays/production

  # Prune resources
  prune: true

  # Wait for resources to be ready
  wait: true

  # Target namespace
  targetNamespace: production

  # Health assessment timeout
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: supertool
      namespace: production

  # Post-build variable substitution (optional)
  postBuild:
    substitute:
      ENVIRONMENT: "production"
    substituteFrom:
      - kind: ConfigMap
        name: cluster-config
        optional: true

  # Decryption (for sealed secrets)
  decryption:
    provider: sops
    secretRef:
      name: sops-gpg

  # Dependencies (deploy after these)
  dependsOn:
    - name: infrastructure
      namespace: flux-system
